---
title: "16S internkontroll logg"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
    html_document:
        toc: true
params:
    #COUNT_DATA: "/usr/local/src/data/emu-combined-species-counts.tsv" # For Docker
    COUNT_DATA: "../data/emu-combined-species-counts.tsv" # For testing locally
---

<style>
   tbody tr:nth-child(odd){
    background-color: #F7FBFF;
  }
</style>

```{r dependencies, include = FALSE}
library(vegan)
library(knitr)
#source("/usr/local/src/rscripts/ordiellipse_custom_scale.R") # For Docker
source("ordiellipse_custom_scale.R") # For testing locally
environment(ordiellipse_custom_scale) = asNamespace('vegan')
```

```{r Read parameters, include = FALSE}
COUNT_DATA = params$COUNT_DATA
```

### Postiva kontroller: artblandningar
De första 20 proverna ("twenty") används för att beräkna standardavvikelsen.

```{r data, echo=FALSE}
count_table = read.csv(COUNT_DATA, header=TRUE, sep="\t")
row.names(count_table)=count_table$species
count_table = count_table[,8:ncol(count_table)]
count_table[is.na(count_table)] = 0
colnames(count_table) = sub("X", "", colnames(count_table)) # remove X

# Factors
factors = as.data.frame(names(count_table))
row.names(factors) = factors$`names(count_table)`
factors$`names(count_table)` = NULL
factors$sample = as.factor(c(rep("twenty",20),rep("new",(length(row.names(factors))-20))))

# Get new samples
new_samples = names(count_table) %in% row.names(factors)[factors$sample=="new"]

# Print sample list and type
kable(factors, format="html")

# Calculate proportions from counts
prop_table = prop.table(as.matrix(count_table), 2)

```

### PCA
```{r pca, echo=FALSE}
samples.rda = rda(t(prop_table) ~ 1)
colvec = c("red2","white")

# par(mfrow = c(1, 2))
# {plot(samples.rda, display="sites", type="n", main="PCA positiva kontroller")
# with(factors, points(samples.rda, display="sites", pch=21, bg=colvec[sample]))
# with(factors, legend("topright", legend=levels(sample), bty="n", pch=21, col="black", pt.bg=colvec))}
# 
#{plot(samples.rda, display="sites", type="n", main="PCA positiva kontroller")
#points(samples.rda, select=!new_samples, display="sites", pch=21)
# text(samples.rda, select=new_samples, display="sites", cex=1)}
#ordilabel(samples.rda, select=new_samples, display="sites", cex=0.5)}
#orditorp(samples.rda, select=new_samples, display="sites", cex=0.5, pch=21, bg="red")}
#ordipointlabel(samples.rda, select=new_samples, display="sites", cex=0.5, pch=21, bg="red")}


par(mfrow = c(1, 1))
# 2STDAV
{plot(samples.rda, display="sites", type="n", main="2 standardavvikelser")
with(factors, points(samples.rda, display="sites", pch=21, bg=colvec[sample]))
with(factors, ordiellipse_custom_scale(samples.rda, sample, show.groups="twenty", kind="sd", scale.custom=2, draw="polygon", col="skyblue", border="blue"))
with(factors, legend("topright", legend=levels(sample), bty="n", pch=21, col="black", pt.bg=colvec))}

#plot(samples.rda, display="sites", type="n", main="2 standardavvikelser - bara nya prover")
#points(samples.rda, select=!new_samples, display="sites", pch=21)
#text(samples.rda, select=new_samples, display="sites", cex=0.5)
{ordipointlabel(samples.rda, select=new_samples, display="sites", cex=0.75, pch=21, bg="red")
with(factors, ordiellipse_custom_scale(samples.rda, sample, show.groups="twenty", kind="sd", scale.custom=2, draw="polygon", col="skyblue", border="blue"))
with(factors, legend("topright", legend="new", bty="n", pch=21, col="black", pt.bg="red"))}

# 3STDAV
{plot(samples.rda, display="sites", type="n", main="3 standardavvikelser")
with(factors, points(samples.rda, display="sites", pch=21, bg=colvec[sample]))
with(factors, ordiellipse_custom_scale(samples.rda, sample, show.groups="twenty", kind="sd", scale.custom=3, draw="polygon", col="skyblue", border="blue"))
with(factors, legend("topright", legend=levels(sample), bty="n", pch=21, col="black", pt.bg=colvec))}

#{plot(samples.rda, display="sites", type="n", main="3 standardavvikelser - bara nya prover")
#points(samples.rda, select=!new_samples, display="sites", pch=21)
#text(samples.rda, select=new_samples, display="sites", cex=0.5)
{ordipointlabel(samples.rda, select=new_samples, display="sites", cex=0.75, pch=21, bg="red")
with(factors, ordiellipse_custom_scale(samples.rda, sample, show.groups="twenty", kind="sd", scale.custom=3, draw="polygon", col="skyblue", border="blue"))
with(factors, legend("topright", legend="new", bty="n", pch=21, col="black", pt.bg="red"))}


```

